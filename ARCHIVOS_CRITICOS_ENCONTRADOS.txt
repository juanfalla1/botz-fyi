================================================================================
ARCHIVOS CR√çTICOS ENCONTRADOS EN LA INVESTIGACI√ìN
================================================================================

PROBLEMA 1: GOOGLE OAUTH ROTO (AUTENTICACI√ìN DE USUARIO)
================================================================================

1. ARCHIVOS DE AUTENTICACI√ìN OAUTH:
   
   üìÑ app/start/components/AuthModal.tsx (L√çNEAS 33-49)
      - Funci√≥n: handleGoogle()
      - Problema: signInWithOAuth({ provider: "google" })
      - Requiere: Supabase OAuth Provider configurado
      - Status: C√≥digo est√° correcto, falta config en Supabase
   
   üìÑ app/pricing/page.tsx (L√çNEAS 330-342)
      - Funci√≥n: handleGoogleLogin()
      - Problema: Mismo que AuthModal
      - Requiere: Supabase OAuth Provider configurado
      - Status: C√≥digo est√° correcto
   
   üìÑ supabaseClient.ts (L√çNEAS 1-21)
      - Configuraci√≥n: Cliente Supabase
      - URL: https://chyzxaspglbwnenagtjv.supabase.co
      - ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
      - Status: ‚úÖ Configurado correctamente en .env.local

2. VARIABLES DE ENTORNO NECESARIAS (.env.local):
   
   L√çNEA 1: NEXT_PUBLIC_SUPABASE_URL="https://chyzxaspglbwnenagtjv.supabase.co"
   L√çNEA 2: NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
   
   ‚ö†Ô∏è FALTA CONFIGURAR EN SUPABASE DASHBOARD:
      - Ir a: https://app.supabase.com/project/chyzxaspglbwnenagtjv
      - Secci√≥n: Authentication > Providers > Google
      - Agregar:
        * Client ID: 417058045568-hheokiaia74qgr7lvfcgugpbenq8kq3t.apps.googleusercontent.com
        * Client Secret: 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

3. GOOGLE CREDENTIALS (PARA INTEGRACIONES, NO OAUTH AUTH):
   
   üìÑ .env.local (L√çNEAS 15-17)
      GOOGLE_CLIENT_ID="417058045568-hheokiaia74qgr7lvfcgugpbenq8kq3t.apps.googleusercontent.com"
      GOOGLE_CLIENT_SECRET="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"
      GOOGLE_REDIRECT_URI="http://localhost:3000/api/integrations/google/callback"
      Status: ‚úÖ Presente
   
   üìÑ app/api/integrations/google/init/route.ts (L√çNEAS 19-44)
      - Funci√≥n: Iniciar OAuth para conexi√≥n de Gmail
      - Estado: ‚úÖ Correcto
      - No es problema de auth de usuario
   
   üìÑ app/api/integrations/google/callback/route.ts (L√çNEAS 31-195)
      - Funci√≥n: Recibir callback de Google OAuth
      - Estado: ‚úÖ Correcto
      - No es problema de auth de usuario

================================================================================

PROBLEMA 2: FLUJO DEMO/TRIAL NO CARGA DATOS
================================================================================

1. ARCHIVO PRINCIPAL - ACEPTACI√ìN DE INVITACI√ìN:
   
   üìÑ app/accept-invite/[inviteId]/page.tsx (410 L√çNEAS)
      
      L√çNEAS 8-14: Interfaz InviteData
         interface InviteData {
           id: string;
           email: string;
           role: string;
           access_level: string;
           status: string;
         }
      
      L√çNEAS 16-81: Componente main, funci√≥n verifyInvite()
         - Valida invitaci√≥n via API
         - Endpoint: /api/platform/admin-invites/validate?inviteId=...
      
      ‚ùå PROBLEMA CR√çTICO - L√çNEAS 114-172: Funci√≥n handleSetupPassword()
         
         const { data: authData, error: authError } = await supabase.auth.signUp({
           email: invite.email,
           password,
           options: {
             data: {
               role: invite.role,
               access_level: invite.access_level,
               // ‚ùå NO GUARDA: tenant_id
               // ‚ùå NO GUARDA: empresa/nombre
             },
           },
         });
         
         ‚ùå FALTA: No crea entrada en tabla "tenants"
         ‚ùå FALTA: No crea entrada en tabla "team_members" con tenant_id
         ‚ùå FALTA: No crea entrada en tabla "subscriptions"
         
         ‚úÖ S√ç HACE: Agrega a platform_admins (l√≠neas 144-154)
         ‚úÖ S√ç HACE: Actualiza admin_invites.status (l√≠neas 157-164)

2. ARCHIVO DE AUTENTICACI√ìN Y SUSCRIPCI√ìN - MAIN LAYOUT:
   
   üìÑ app/start/MainLayout.tsx (1771+ L√çNEAS)
      
      CONTEXTO: AuthProvider + AuthContext
      
      L√çNEAS 68-78: PLAN_FEATURES
         const PLAN_FEATURES: Record<string, string[]> = {
           free: ["demo"],  // ‚ùå Solo "demo"
           "B√°sico": ALL_FEATURES,
           Growth: ALL_FEATURES,
           // ...
         };
      
      L√çNEAS 322-343: applySubscription()
         const applySubscription = useCallback((activeSub: any | null) => {
           if (activeSub) {
             setSubscription(activeSub);
             const tenantPlan = activeSub.plan || "free";
             setUserPlan(tenantPlan);
             const planFeatures = PLAN_FEATURES[tenantPlan] || PLAN_FEATURES["free"];
             setEnabledFeatures(planFeatures);  // ‚ùå Si activeSub=null, solo "demo"
           } else {
             setUserPlan("free");
             setSubscription(null);
             setEnabledFeatures(PLAN_FEATURES["free"]);  // ‚ùå Solo ["demo"]
           }
         }, []);
      
      ‚ùå PROBLEMA: Si no hay suscripci√≥n, usuario queda bloqueado
      
      L√çNEAS 396-531: fetchUserSubscription()
         async (userId: string, tenantId?: string | null) => {
           // PASO 1: Buscar por user_id (usuarios admin)
           // PASO 2: Si no, buscar por tenant_id
           // PASO 3: Si no, buscar en team_members
           
           applySubscription(activeSub);  // ‚ùå Si activeSub=null, falla
         }
      
      ‚ùå PROBLEMA: Para demo users:
         - PASO 1: No hay entrada subscriptions con user_id
         - PASO 2: Faltan tenant_id
         - PASO 3: No hay team_member
         - Resultado: activeSub = null ‚Üí Solo "demo" features
      
      L√çNEAS 540-637: detectUserRole()
         async (authUserId: string, email: string) => {
           // Busca en team_members por auth_user_id O email
           // Si no encuentra: rol = "asesor" sin datos
         }
      
      ‚ùå PROBLEMA: No hay team_member para demo users

3. API DE VALIDACI√ìN DE INVITACIONES:
   
   üìÑ app/api/platform/admin-invites/validate/route.ts (60 L√çNEAS)
      - Funci√≥n: Validar invitaci√≥n
      - Endpoint: GET /api/platform/admin-invites/validate?inviteId=...
      - Status: ‚úÖ Correcto
      - Solo valida, no crea datos

4. GUARDIAS DE ACCESO A API:
   
   üìÑ app/api/_utils/guards.ts (92 L√çNEAS)
      
      L√çNEA 58-91: assertTenantAccess()
         export async function assertTenantAccess(params: {
           req: Request;
           requestedTenantId?: string | null;
           allowPlatformAdminCrossTenant?: boolean;
         })
      
      ‚ùå PROBLEMA CR√çTICO (L√çNEAS 71-88):
         
         if (pa.isAdmin) {  // ‚Üê Demo user ES platform_admin
           if (!requestedTenantId) {
             return { ok: false, error: "Missing tenantId" };  // ‚ùå BLOQUEA
           }
           return { ok: true, tenantId: requestedTenantId };
         }
         
         // Si NO es admin:
         const tm = await getTeamMemberByAuthUserId(user.id);
         if (!tm.row?.tenant_id) {
           return { ok: false, status: 403, error: "Forbidden" };  // ‚ùå BLOQUEA
         }
      
      ‚úÖ SOLUCI√ìN: Demo user ES platform_admin, pero:
         - Necesita requestedTenantId en cada API call
         - O deber√≠a tener un team_member con tenant_id asignado

5. STRIPE CHECKOUT:
   
   üìÑ app/api/stripe/create-checkout-session/route.ts (125 L√çNEAS)
      
      L√çNEAS 59-124: POST handler
         - Requiere: userId, tenantId, plan
         - ‚úÖ Valida que exista tenantId (l√≠nea 72-74)
         - ‚úÖ Crea metadata con tenantId
      
      ‚ùå PROBLEMA: Demo users sin tenantId no pueden hacer checkout
         if (!tenantId) {
           return { ok: false, error: "NO_TENANT_ID" };
         }

================================================================================

PROBLEMA 3: EMAIL info@botz.fyi FUNCIONA BIEN
================================================================================

1. POR QU√â FUNCIONA:
   
   ‚úÖ Existe entrada en team_members:
      - email = 'info@botz.fyi'
      - tenant_id = [V√ÅLIDO]
      - auth_user_id = [VINCULADO 
